<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>Keen IO Visualization JS Test</title>
  <style>
    /*body .cs-widget {
      background: #000;
    }*/
  </style>
</head>
<body>

  <div id="client-dot-draw-demo"></div>

  <div id="funnel"></div>

  <metric title="Total Pageviews" width="300"
    dataset="https://api.keen.io/3.0/projects/52f2ae5905cd661a7800000a/queries/count
      ?api_key=4e4d72e5bf8b69686ed87a5a9671bba7ad829fbd10a1c281ee51b6e9c1ce9548e941e1f336f9de9281a5acc66ca8fdabc9b3c806e390eca01665f6a308a9b03d8b332b3fbd9f3cdfc3b3e16b0da6d84851e53fe20fbbce300801b8a401a6395b9f4ab9c89bff566e9678a74ca6624f9b
      &event_collection=pageview
      &timezone=-28800"></metric>
  <br/>
  <div id="gbx2-js"></div>
  <div id="metric-js"></div>
  <div id="chart1"></div>
  <div id="chart2"></div>
  <div id="pie-js"></div>
  <div id="table-js"></div>

  <script src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="../../dist/keen-3.0.0.visualize.js"></script>
  <script>

    var keen = new Keen({
      projectId: "52f2ae5905cd661a7800000a",
      readKey: "4e4d72e5bf8b69686ed87a5a9671bba7ad829fbd10a1c281ee51b6e9c1ce9548e941e1f336f9de9281a5acc66ca8fdabc9b3c806e390eca01665f6a308a9b03d8b332b3fbd9f3cdfc3b3e16b0da6d84851e53fe20fbbce300801b8a401a6395b9f4ab9c89bff566e9678a74ca6624f9b",
      requestType: "jsonp"
    });

    var num = new Keen.Query("count", {
      event_collection: "pageview"
    });

    var pie = new Keen.Query("count", {
      event_collection: "pageview",
      group_by: "page"
    });

    var line = new Keen.Query("count", {
      event_collection: "pageview",
      group_by: "page",
      timeframe: "this_5_months",
      interval: "monthly"
    });

    var ext = new Keen.Query("extraction", {
      eventCollection: "pageview",
      latest: 10,
      property_names: ["page", "referrer"]
    });

    var funnel = new Keen.Query("funnel", {
      steps: [
        {
          event_collection: "pageview",
          actor_property: "page"
        },
        {
          event_collection: "viewed_twentyfive",
          actor_property: "page"
        },
        {
          event_collection: "viewed_fifty",
          actor_property: "page"
        },
        {
          event_collection: "viewed_seventyfive",
          actor_property: "page"
        },
        {
          event_collection: "viewed_all",
          actor_property: "page"
        }
      ]
    });

    /*keen.run([num, pie, line, funnel], function(){
      // this.data = [{}, {}, {}, {}];
    });*/



    Keen.ready(function(){

      keen.draw(funnel, document.getElementById("client-dot-draw-demo"), {
        title: "Funnel in #client-dot-draw-demo"
      });

      window.count = keen.run(line, function(){
        this.draw(document.getElementById("chart1"), {
          title: "Line via query#draw"
        });
      });
      window.chart = new Keen.Visualization(window.count, document.getElementById("chart2"), {
        //library: "google",
        chartType: 'barchart',
        dateFormat: "MMM DD",
        title: "Line via new var",
        height: 270,
        width: 500,
        chartOptions: {
          isStacked: true
        }
      });


      keen.run(line, function(res){
        // console.log(res);
        var newData = res;
        for (var i = 0; i < res.result.length; i++) {
          for (var j = 0; j < res.result[i].value.length; j++) {
            newData.result[i].value[j].result = Math.floor(Math.random() * (500 - 100 + 1)) + 100;
          }
        }
        this.data = newData;
        this.draw(document.getElementById("table-js"), {
          title: "test!"
        })
        //console.log('newData', newData);
      });



      return false;



      var widget = keen.run(funnel, function(res){
        console.log('funnel', this.data);
        this.draw(document.getElementById("funnel"), {
          title: "Funfunfunnel",
          chartOptions: {
            bar: {groupWidth:'97%'}
          }
        })
      });

      widget.queries[0].set({ groupBy: 'page' });
      widget.refresh();

      pieq = keen.run(pie);
      pieq.on("complete", function(){
        this.draw(document.getElementById("pie-js"), {
          chartType: 'piechart',
          title: "Chart",
          height: 270
        });
      });


      query = keen.run(line);
      query.on("complete", function(){

        this.draw(document.getElementById("chart1"), {
          //library: "google",
          dateFormat: "MMMM DD",
          title: "Chart via this.draw",
          height: 270,
          chartOptions: {
            pieHole: 0.35
          }
        });

      });

      window.chart = new Keen.Visualization(query, document.getElementById("chart2"), {
        //library: "google",
        chartType: 'barchart',
        dateFormat: "MMM DD",
        title: "Chart via pointer var",
        height: 270,
        width: 500,
        chartOptions: {
          isStacked: true
        }
      });

      keen.draw(num, document.getElementById("metric-js"));

      keen.run(line, function(res){
        console.log(res);
        var newData = res;
        for (var i = 0; i < res.result.length; i++) {
          for (var j = 0; j < res.result[i].value.length; j++) {
            newData.result[i].value[j].result = res.result[i].value[j].result * 100;
          }
        }
        this.data = newData;
        this.draw(document.getElementById("table-js"), {
          title: "test!"
        })
        console.log('newData', newData);
      })
      /*keen.draw(ext, document.getElementById("table-js"), {
        chartType: "datatable"
      });*/

    });

  </script>
</body>
</html>
